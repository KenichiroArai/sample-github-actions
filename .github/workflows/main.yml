name: ã‚µãƒ³ãƒ—ãƒ«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ - ä¸¦åˆ—å‡¦ç†ãƒ‡ãƒ¢

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹

# ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
env:
  GLOBAL_VAR: "ã‚°ãƒ­ãƒ¼ãƒãƒ«ç’°å¢ƒå¤‰æ•°"
  BUILD_DATE: ${{ github.event.head_commit.timestamp }}

jobs:
  # ã‚¸ãƒ§ãƒ–1: ä¸¦åˆ—å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†A
  parallel-job-a:
    name: "ä¸¦åˆ—ã‚¸ãƒ§ãƒ–A - Linuxç’°å¢ƒ"
    runs-on: ubuntu-latest

    steps:
      # Step 1: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆå…¬å¼Actionä½¿ç”¨ï¼‰
      - name: "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4

      # Step 2: ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
      - name: "å‡¦ç†A - ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ"
        run: |
          echo "=== ã‚¸ãƒ§ãƒ–Aé–‹å§‹ ==="
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date)"
          echo "ãƒ©ãƒ³ãƒŠãƒ¼OS: $RUNNER_OS"
          echo "ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°: $GLOBAL_VAR"

          # çµæžœãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
          mkdir -p output
          cat > output/result-a.txt << EOF
          ã€ã‚¸ãƒ§ãƒ–Aå®Ÿè¡Œçµæžœã€‘
          å®Ÿè¡Œæ™‚åˆ»: $(date)
          ãƒ©ãƒ³ãƒŠãƒ¼: $RUNNER_OS
          ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}
          ã‚³ãƒŸãƒƒãƒˆSHA: ${{ github.sha }}
          å‡¦ç†å†…å®¹: ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆAã®å‡¦ç†å®Œäº†
          ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ“ æˆåŠŸ
          EOF

          cat output/result-a.txt

          # å‡¦ç†æ™‚é–“ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
          sleep 5
          echo "ã‚¸ãƒ§ãƒ–Aå®Œäº†!"
        shell: bash

      # Step 3: Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œ
      - name: "Pythonè§£æžã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ"
        run: python scripts/analyze.py --job-name "JobA" --output output/analysis-a.json

      # Step 4: ã‚«ã‚¹ã‚¿ãƒ Actionã®ä½¿ç”¨
      - name: "ã‚«ã‚¹ã‚¿ãƒ Actionå®Ÿè¡Œ"
        uses: ./.github/actions/custom-action
        with:
          job-name: "Job-A"
          message: "ä¸¦åˆ—å‡¦ç†Aã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"

      # Step 5: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆå…¬å¼Actionä½¿ç”¨ï¼‰
      - name: "çµæžœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜"
        uses: actions/upload-artifact@v4
        with:
          name: job-a-results
          path: output/
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–2: ä¸¦åˆ—å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†B
  parallel-job-b:
    name: "ä¸¦åˆ—ã‚¸ãƒ§ãƒ–B - Windowsç’°å¢ƒ"
    runs-on: windows-latest

    steps:
      - name: "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4

      - name: "å‡¦ç†B - ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ"
        run: |
          echo "=== ã‚¸ãƒ§ãƒ–Bé–‹å§‹ ==="
          echo "å®Ÿè¡Œæ™‚åˆ»: $(Get-Date)"
          echo "ãƒ©ãƒ³ãƒŠãƒ¼OS: $env:RUNNER_OS"
          echo "ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°: $env:GLOBAL_VAR"

          # çµæžœãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
          New-Item -ItemType Directory -Force -Path output

          $result = @"
          ã€ã‚¸ãƒ§ãƒ–Bå®Ÿè¡Œçµæžœã€‘
          å®Ÿè¡Œæ™‚åˆ»: $(Get-Date)
          ãƒ©ãƒ³ãƒŠãƒ¼: $env:RUNNER_OS
          ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}
          ã‚³ãƒŸãƒƒãƒˆSHA: ${{ github.sha }}
          å‡¦ç†å†…å®¹: ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆBã®å‡¦ç†å®Œäº†
          ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ“ æˆåŠŸ
          "@

          $result | Out-File -FilePath output/result-b.txt -Encoding UTF8
          Get-Content output/result-b.txt

          # å‡¦ç†æ™‚é–“ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
          Start-Sleep -Seconds 7
          echo "ã‚¸ãƒ§ãƒ–Bå®Œäº†!"
        shell: pwsh

      - name: "PowerShellã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ"
        run: |
          python scripts/analyze.py --job-name "JobB" --output output/analysis-b.json
        shell: pwsh

      - name: "ã‚«ã‚¹ã‚¿ãƒ Actionå®Ÿè¡Œ"
        uses: ./.github/actions/custom-action
        with:
          job-name: "Job-B"
          message: "ä¸¦åˆ—å‡¦ç†Bã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"

      - name: "çµæžœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜"
        uses: actions/upload-artifact@v4
        with:
          name: job-b-results
          path: output/
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–3: ä¸¦åˆ—å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†C
  parallel-job-c:
    name: "ä¸¦åˆ—ã‚¸ãƒ§ãƒ–C - macOSç’°å¢ƒ"
    runs-on: macos-latest

    steps:
      - name: "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4

      - name: "å‡¦ç†C - ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ"
        run: |
          echo "=== ã‚¸ãƒ§ãƒ–Cé–‹å§‹ ==="
          echo "å®Ÿè¡Œæ™‚åˆ»: $(date)"
          echo "ãƒ©ãƒ³ãƒŠãƒ¼OS: $RUNNER_OS"
          echo "ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°: $GLOBAL_VAR"

          # çµæžœãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
          mkdir -p output
          cat > output/result-c.txt << EOF
          ã€ã‚¸ãƒ§ãƒ–Cå®Ÿè¡Œçµæžœã€‘
          å®Ÿè¡Œæ™‚åˆ»: $(date)
          ãƒ©ãƒ³ãƒŠãƒ¼: $RUNNER_OS
          ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref }}
          ã‚³ãƒŸãƒƒãƒˆSHA: ${{ github.sha }}
          å‡¦ç†å†…å®¹: ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆCã®å‡¦ç†å®Œäº†
          ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ“ æˆåŠŸ
          EOF

          cat output/result-c.txt

          # å‡¦ç†æ™‚é–“ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
          sleep 6
          echo "ã‚¸ãƒ§ãƒ–Cå®Œäº†!"
        shell: bash

      - name: "Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ"
        run: python3 scripts/analyze.py --job-name "JobC" --output output/analysis-c.json

      - name: "ã‚«ã‚¹ã‚¿ãƒ Actionå®Ÿè¡Œ"
        uses: ./.github/actions/custom-action
        with:
          job-name: "Job-C"
          message: "ä¸¦åˆ—å‡¦ç†Cã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"

      - name: "çµæžœã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜"
        uses: actions/upload-artifact@v4
        with:
          name: job-c-results
          path: output/
          retention-days: 30

  # ã‚¸ãƒ§ãƒ–4: é›†ç´„å‡¦ç†ï¼ˆä¸¦åˆ—ã‚¸ãƒ§ãƒ–ã®å®Œäº†å¾Œã«å®Ÿè¡Œï¼‰
  aggregate-results:
    name: "çµæžœã®é›†ç´„ã¨æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ"
    runs-on: ubuntu-latest
    needs: [parallel-job-a, parallel-job-b, parallel-job-c]  # ä¾å­˜é–¢ä¿‚ã®å®šç¾©

    steps:
      - name: "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4

      # å…¨ã¦ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      - name: "ã‚¸ãƒ§ãƒ–Aã®çµæžœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
        uses: actions/download-artifact@v4
        with:
          name: job-a-results
          path: results/job-a

      - name: "ã‚¸ãƒ§ãƒ–Bã®çµæžœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
        uses: actions/download-artifact@v4
        with:
          name: job-b-results
          path: results/job-b

      - name: "ã‚¸ãƒ§ãƒ–Cã®çµæžœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
        uses: actions/download-artifact@v4
        with:
          name: job-c-results
          path: results/job-c

      # çµæžœã®é›†ç´„
      - name: "å…¨çµæžœã®é›†ç´„"
        run: |
          echo "=== å…¨ã‚¸ãƒ§ãƒ–ã®çµæžœã‚’é›†ç´„ ==="
          echo ""

          mkdir -p final-output

          # æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆã®ä½œæˆ
          cat > final-output/final-report.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        GitHub Actions ä¸¦åˆ—å‡¦ç†å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ            â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å: ${{ github.workflow }}
          å®Ÿè¡Œç•ªå·: ${{ github.run_number }}
          å®Ÿè¡ŒID: ${{ github.run_id }}
          ãƒˆãƒªã‚¬ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ: ${{ github.event_name }}
          ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}
          å®Ÿè¡Œè€…: ${{ github.actor }}

          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          ã€ä¸¦åˆ—å®Ÿè¡Œã•ã‚ŒãŸã‚¸ãƒ§ãƒ–ã€‘
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

          EOF

          # å„ã‚¸ãƒ§ãƒ–ã®çµæžœã‚’çµ±åˆ
          echo "ðŸ“‹ ã‚¸ãƒ§ãƒ–Aï¼ˆLinuxï¼‰ã®çµæžœ:" >> final-output/final-report.txt
          cat results/job-a/result-a.txt >> final-output/final-report.txt
          echo "" >> final-output/final-report.txt
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> final-output/final-report.txt

          echo "ðŸ“‹ ã‚¸ãƒ§ãƒ–Bï¼ˆWindowsï¼‰ã®çµæžœ:" >> final-output/final-report.txt
          cat results/job-b/result-b.txt >> final-output/final-report.txt
          echo "" >> final-output/final-report.txt
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> final-output/final-report.txt

          echo "ðŸ“‹ ã‚¸ãƒ§ãƒ–Cï¼ˆmacOSï¼‰ã®çµæžœ:" >> final-output/final-report.txt
          cat results/job-c/result-c.txt >> final-output/final-report.txt
          echo "" >> final-output/final-report.txt
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> final-output/final-report.txt

          echo "" >> final-output/final-report.txt
          echo "âœ… å…¨ã¦ã®ä¸¦åˆ—ã‚¸ãƒ§ãƒ–ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼" >> final-output/final-report.txt
          echo "å®Œäº†æ™‚åˆ»: $(date)" >> final-output/final-report.txt

          # ãƒ¬ãƒãƒ¼ãƒˆã®è¡¨ç¤º
          cat final-output/final-report.txt

          # çµ±è¨ˆæƒ…å ±ã®ç”Ÿæˆ
          echo '{"total_jobs": 3, "status": "success", "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' > final-output/statistics.json

      - name: "æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜"
        uses: actions/upload-artifact@v4
        with:
          name: final-report
          path: final-output/
          retention-days: 90

      - name: "ã‚µãƒžãƒªãƒ¼ã®ä½œæˆ"
        run: |
          echo "## ðŸŽ‰ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ã‚¸ãƒ§ãƒ–Aï¼ˆLinuxï¼‰: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ã‚¸ãƒ§ãƒ–Bï¼ˆWindowsï¼‰: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… ã‚¸ãƒ§ãƒ–Cï¼ˆmacOSï¼‰: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "- job-a-results" >> $GITHUB_STEP_SUMMARY
          echo "- job-b-results" >> $GITHUB_STEP_SUMMARY
          echo "- job-c-results" >> $GITHUB_STEP_SUMMARY
          echo "- final-reportï¼ˆçµ±åˆãƒ¬ãƒãƒ¼ãƒˆï¼‰" >> $GITHUB_STEP_SUMMARY

