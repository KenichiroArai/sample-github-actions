name: ãƒãƒˆãƒªãƒƒã‚¯ã‚¹æˆ¦ç•¥ - ä¸¦åˆ—å‡¦ç†ãƒ‡ãƒ¢

# ãƒãƒˆãƒªãƒƒã‚¯ã‚¹æˆ¦ç•¥ã‚’ä½¿ç”¨ã—ãŸä¸¦åˆ—å®Ÿè¡Œã®ãƒ‡ãƒ¢
on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  # ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã‚¸ãƒ§ãƒ–: è¤‡æ•°ã®OSÃ—è¤‡æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ä¸¦åˆ—å®Ÿè¡Œ
  matrix-test:
    name: "ãƒ†ã‚¹ãƒˆ (${{ matrix.os }}, Python ${{ matrix.python-version }})"
    runs-on: ${{ matrix.os }}

    # ãƒãƒˆãƒªãƒƒã‚¯ã‚¹å®šç¾© - å…¨ã¦ã®çµ„ã¿åˆã‚ã›ãŒä¸¦åˆ—å®Ÿè¡Œã•ã‚Œã‚‹
    strategy:
      # fail-fast: falseã§ã€1ã¤å¤±æ•—ã—ã¦ã‚‚ä»–ã¯ç¶™ç¶š
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.9", "3.10", "3.11", "3.12"]
        # 3 OS Ã— 4 Python = 12å€‹ã®ã‚¸ãƒ§ãƒ–ãŒä¸¦åˆ—å®Ÿè¡Œï¼

    steps:
      - name: "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4

      - name: "Python ${{ matrix.python-version }} ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: "ç’°å¢ƒæƒ…å ±ã®è¡¨ç¤º"
        run: |
          python --version
          python -c "import sys; print(f'Pythonå®Ÿè¡Œãƒ‘ã‚¹: {sys.executable}')"
          python -c "import platform; print(f'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : {platform.platform()}')"
        env:
          PYTHONIOENCODING: utf-8

      - name: "ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "OS: ${{ matrix.os }}"
          echo "Python: ${{ matrix.python-version }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          python -c "
          import json
          import sys
          from datetime import datetime

          result = {
              'os': '${{ matrix.os }}',
              'python_version': '${{ matrix.python-version }}',
              'timestamp': datetime.now().isoformat(),
              'test_passed': True,
              'test_count': 42,
              'duration_ms': 123.45
          }

          print('âœ… ãƒ†ã‚¹ãƒˆå®Œäº†')
          print(json.dumps(result, indent=2))
          "

      - name: "çµæœãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ"
        shell: bash
        run: |
          mkdir -p test-results

          # OSåã‚’æ­£è¦åŒ–ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åç”¨ï¼‰
          OS_NAME="${{ matrix.os }}"
          OS_CLEAN=$(echo "$OS_NAME" | sed 's/-latest//')

          python -c "
          import json
          from datetime import datetime

          result = {
              'os': '${{ matrix.os }}',
              'python_version': '${{ matrix.python-version }}',
              'timestamp': datetime.now().isoformat(),
              'runner_name': '${{ runner.name }}',
              'test_results': {
                  'total': 42,
                  'passed': 42,
                  'failed': 0,
                  'skipped': 0
              },
              'status': 'success'
          }

          with open('test-results/result.json', 'w') as f:
              json.dump(result, f, indent=2)
          "

          echo "ğŸ“ çµæœãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†: ${OS_CLEAN}-py${{ matrix.python-version }}"

      - name: "ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜"
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-py${{ matrix.python-version }}
          path: test-results/

  # ä¸¦åˆ—å®Ÿè¡Œã®å¯è¦–åŒ–ã‚¸ãƒ§ãƒ–
  visualize-parallel:
    name: "ä¸¦åˆ—å®Ÿè¡Œã®å¯è¦–åŒ–"
    runs-on: ubuntu-latest
    if: always()
    needs: [matrix-test]

    steps:
      - name: "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ"
        uses: actions/checkout@v4

      - name: "å…¨çµæœã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
        uses: actions/download-artifact@v4
        with:
          path: all-results

      - name: "çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ"
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "         ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ä¸¦åˆ—å®Ÿè¡Œ çµ±è¨ˆãƒ¬ãƒãƒ¼ãƒˆ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          total_jobs=0
          successful_jobs=0

          for dir in all-results/*/; do
            if [ -f "${dir}result.json" ]; then
              total_jobs=$((total_jobs + 1))

              # JSONã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
              os=$(python3 -c "import json; data=json.load(open('${dir}result.json')); print(data['os'])")
              py_ver=$(python3 -c "import json; data=json.load(open('${dir}result.json')); print(data['python_version'])")
              status=$(python3 -c "import json; data=json.load(open('${dir}result.json')); print(data['status'])")

              if [ "$status" = "success" ]; then
                successful_jobs=$((successful_jobs + 1))
                echo "âœ… $os - Python $py_ver"
              else
                echo "âŒ $os - Python $py_ver"
              fi
            fi
          done

          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š é›†è¨ˆçµæœ:"
          echo "   ç·ã‚¸ãƒ§ãƒ–æ•°: $total_jobs"
          echo "   æˆåŠŸ: $successful_jobs"
          echo "   å¤±æ•—: $((total_jobs - successful_jobs))"
          echo "   æˆåŠŸç‡: $(python3 -c "print(f'{$successful_jobs/$total_jobs*100:.1f}%')")"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: "ãƒãƒˆãƒªãƒƒã‚¯ã‚¹å®Ÿè¡Œãƒãƒƒãƒ—ã®ç”Ÿæˆ"
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          from pathlib import Path

          print("ğŸ—ºï¸  ãƒãƒˆãƒªãƒƒã‚¯ã‚¹å®Ÿè¡Œãƒãƒƒãƒ—ã‚’ç”Ÿæˆä¸­...")

          # å…¨çµæœã‚’åé›†
          results = []
          results_dir = Path("all-results")

          for result_file in results_dir.glob("*/result.json"):
              with open(result_file) as f:
                  results.append(json.load(f))

          # OSã¨Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
          os_list = sorted(set(r['os'] for r in results))
          py_versions = sorted(set(r['python_version'] for r in results))

          # HTMLãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          html = """
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>ãƒãƒˆãƒªãƒƒã‚¯ã‚¹å®Ÿè¡Œçµæœ</title>
              <style>
                  body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                         padding: 20px; background: #f5f5f5; }
                  h1 { color: #333; }
                  table { border-collapse: collapse; background: white;
                          box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                  th, td { padding: 15px; text-align: center; border: 1px solid #ddd; }
                  th { background: #2196F3; color: white; font-weight: bold; }
                  .success { background: #4CAF50; color: white; }
                  .header-col { background: #1976D2; color: white; font-weight: bold; }
              </style>
          </head>
          <body>
              <h1>ğŸ¯ GitHub Actions ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ä¸¦åˆ—å®Ÿè¡Œãƒãƒƒãƒ—</h1>
              <p>å®Ÿè¡Œæ™‚åˆ»: """ + results[0]['timestamp'] + """</p>
              <table>
                  <tr>
                      <th>OS / Python</th>
          """

          for py_ver in py_versions:
              html += f"            <th>Python {py_ver}</th>\n"

          html += "        </tr>\n"

          # å„OSã®è¡Œã‚’ä½œæˆ
          for os in os_list:
              os_display = os.replace('-latest', '')
              html += f"        <tr>\n            <td class='header-col'>{os_display}</td>\n"

              for py_ver in py_versions:
                  # ã“ã®çµ„ã¿åˆã‚ã›ã®çµæœã‚’æ¤œç´¢
                  result = next((r for r in results
                               if r['os'] == os and r['python_version'] == py_ver), None)

                  if result and result['status'] == 'success':
                      html += f"            <td class='success'>âœ… æˆåŠŸ</td>\n"
                  else:
                      html += "            <td>âŒ å¤±æ•—</td>\n"

              html += "        </tr>\n"

          html += """
              </table>
              <p style='margin-top: 20px; color: #666;'>
                  ğŸ’¡ å…¨ã¦ã®çµ„ã¿åˆã‚ã›ãŒä¸¦åˆ—ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼
              </p>
          </body>
          </html>
          """

          # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
          os.makedirs("reports", exist_ok=True)
          with open("reports/matrix-report.html", "w", encoding="utf-8") as f:
              f.write(html)

          print("âœ… ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†: reports/matrix-report.html")
          PYTHON_SCRIPT

      - name: "ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜"
        uses: actions/upload-artifact@v4
        with:
          name: matrix-execution-report
          path: reports/

      - name: "ã‚µãƒãƒªãƒ¼ä½œæˆ"
        run: |
          echo "## ğŸ¯ ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ä¸¦åˆ—å®Ÿè¡Œå®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ å®Ÿè¡Œæ§‹æˆ" >> $GITHUB_STEP_SUMMARY
          echo "- **OS**: ubuntu, windows, macos (3ç¨®é¡)" >> $GITHUB_STEP_SUMMARY
          echo "- **Python**: 3.9, 3.10, 3.11, 3.12 (4ãƒãƒ¼ã‚¸ãƒ§ãƒ³)" >> $GITHUB_STEP_SUMMARY
          echo "- **ç·ã‚¸ãƒ§ãƒ–æ•°**: 3 Ã— 4 = **12ã‚¸ãƒ§ãƒ–**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ ä¸¦åˆ—å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          echo "å…¨12ã‚¸ãƒ§ãƒ–ãŒ**åŒæ™‚ã«ä¸¦åˆ—å®Ÿè¡Œ**ã•ã‚Œã¾ã—ãŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
          echo "è©³ç´°ãªå®Ÿè¡Œãƒãƒƒãƒ—ã¯ `matrix-execution-report` ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã”ç¢ºèªãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
